<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙˆØ§Ù‚ÙŠØªÙŠ</title>

<style>
:root{
  --bg-light:#f6e7b2;
  --text-light:#0a1f44;
  --card-light:#fff4cc;

  --bg-dark:#0a1f44;
  --text-dark:#f6e7b2;
  --card-dark:#132f5b;

  --gold:#d4af37;
}

body{
  margin:0;
  font-family:"Tajawal",sans-serif;
  background:var(--bg-light);
  color:var(--text-light);
  transition:.3s;
}
body.dark{background:var(--bg-dark);color:var(--text-dark);}

header{
  text-align:center;
  padding:14px;
  font-size:20px;
  font-weight:bold;
}

.card{
  background:var(--card-light);
  margin:10px;
  padding:15px;
  border-radius:14px;
}
body.dark .card{background:var(--card-dark);}

button{
  background:var(--gold);
  color:#0a1f44;
  border:none;
  padding:10px;
  border-radius:10px;
  font-weight:bold;
  margin:4px 0;
}

input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  margin:6px 0;
}

.prayer{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
}
.next{
  border:2px solid var(--gold);
  border-radius:10px;
  padding:8px;
}

nav{
  position:fixed;
  bottom:0;
  width:100%;
  display:flex;
  background:var(--card-light);
}
body.dark nav{background:var(--card-dark);}
nav button{flex:1;border-radius:0;}

#compass{
  width:200px;height:200px;
  border:6px solid var(--gold);
  border-radius:50%;
  margin:15px auto;
  position:relative;
}
#needle{
  width:4px;height:90px;
  background:red;
  position:absolute;
  top:10px;left:50%;
  transform-origin:bottom;
}
#kaaba{
  position:absolute;
  bottom:10px;left:50%;
  transform:translateX(-50%);
  font-size:22px;
}
</style>
</head>

<body>

<header id="title">ğŸ•Œ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</header>

<!-- ğŸ•Œ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª -->
<div class="card" id="prayersPage">
  <div id="cityName">Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹â€¦</div>
  <div id="countdown"></div>
  <div id="prayers"></div>
</div>

<!-- ğŸ“¿ Ø§Ù„Ø£Ø°ÙƒØ§Ø± -->
<div class="card" id="athkarPage" style="display:none">
  <h3>ğŸ“¿ Ø§Ù„Ø£Ø°ÙƒØ§Ø±</h3>
  <button onclick="showAthkar('morning')">Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­</button>
  <button onclick="showAthkar('evening')">Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡</button>
  <button onclick="showAthkar('after')">Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø©</button>
  <button onclick="showAthkar('dua')">Ø£Ø¯Ø¹ÙŠØ©</button>
  <div id="athkarList"></div>
</div>

<!-- ğŸ§­ Ø§Ù„Ù‚Ø¨Ù„Ø© -->
<div class="card" id="qiblaPage" style="display:none">
  <h3>ğŸ§­ Ø§Ù„Ù‚Ø¨Ù„Ø©</h3>
  <div id="compass">
    <div id="needle"></div>
    <div id="kaaba">ğŸ•‹</div>
  </div>
  <p id="qiblaText" style="text-align:center">Ø­Ø±Ù‘Ùƒ Ø§Ù„Ø¬ÙˆØ§Ù„</p>
</div>

<!-- âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
<div class="card" id="settingsPage" style="display:none">
  <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
  <input id="citySearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
  <div id="results"></div>
  <button onclick="toggleDark()">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
</div>

<nav>
  <button onclick="showPage('prayersPage')">ğŸ•Œ</button>
  <button onclick="showPage('athkarPage')">ğŸ“¿</button>
  <button onclick="showPage('qiblaPage')">ğŸ§­</button>
  <button onclick="showPage('settingsPage')">âš™ï¸</button>
</nav>

<script>
let cities=[],prayersData={},dark=false;

// ØµÙØ­Ø§Øª
function showPage(id){
  ["prayersPage","athkarPage","qiblaPage","settingsPage"].forEach(p=>{
    document.getElementById(p).style.display="none";
  });
  document.getElementById(id).style.display="block";
}

// Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
function toggleDark(){
  dark=!dark;
  document.body.classList.toggle("dark");
}

// Ø§Ù„Ù…Ø¯Ù†
fetch("cities-sa.json").then(r=>r.json()).then(d=>cities=d);
document.getElementById("citySearch").oninput=e=>{
  let q=e.target.value,res=document.getElementById("results");
  res.innerHTML="";
  cities.filter(c=>c.includes(q)).forEach(c=>{
    let d=document.createElement("div");
    d.className="card";
    d.innerText=c;
    d.onclick=()=>{
      localStorage.setItem("city",c);
      loadPrayers(c);
    };
    res.appendChild(d);
  });
};

// Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª
function loadPrayers(city){
  document.getElementById("cityName").innerText=city;
  fetch(`https://api.aladhan.com/v1/timingsByCity?city=${city}&country=SA&method=4`)
  .then(r=>r.json()).then(d=>{
    prayersData=d.data.timings;
    renderPrayers();
  });
}

function renderPrayers(){
  const order=["Fajr","Dhuhr","Asr","Maghrib","Isha"];
  const names={Fajr:"Ø§Ù„ÙØ¬Ø±",Dhuhr:"Ø§Ù„Ø¸Ù‡Ø±",Asr:"Ø§Ù„Ø¹ØµØ±",Maghrib:"Ø§Ù„Ù…ØºØ±Ø¨",Isha:"Ø§Ù„Ø¹Ø´Ø§Ø¡"};
  let now=new Date(),next=null;
  for(let p of order){
    let [h,m]=prayersData[p].split(":");
    let t=new Date();t.setHours(h,m,0);
    if(t>now){next=p;break;}
  }
  if(!next)next="Fajr";
  let html="";
  order.forEach(p=>{
    html+=`<div class="prayer ${p===next?"next":""}">
      <span>${names[p]}</span><span>${prayersData[p]}</span></div>`;
  });
  document.getElementById("prayers").innerHTML=html;
  countdown(prayersData[next]);
}

function countdown(time){
  setInterval(()=>{
    let [h,m]=time.split(":");
    let t=new Date();t.setHours(h,m,0);
    let diff=t-new Date();if(diff<0)diff+=86400000;
    let h2=Math.floor(diff/3600000),
        m2=Math.floor(diff%3600000/60000),
        s2=Math.floor(diff%60000/1000);
    document.getElementById("countdown").innerText=
      `Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¨Ø¹Ø¯ ${h2}:${m2}:${s2}`;
  },1000);
}

// ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
navigator.geolocation.getCurrentPosition(pos=>{
  fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=ar`)
  .then(r=>r.json()).then(d=>{
    loadPrayers(d.city||"Ø§Ù„Ø±ÙŠØ§Ø¶");
  });
},()=>loadPrayers(localStorage.getItem("city")||"Ø§Ù„Ø±ÙŠØ§Ø¶"));

// Ø§Ù„Ø£Ø°ÙƒØ§Ø±
const ATHKAR={
  morning:["Ø£ØµØ¨Ø­Ù†Ø§ ÙˆØ£ØµØ¨Ø­ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡","Ø±Ø¶ÙŠØª Ø¨Ø§Ù„Ù„Ù‡ Ø±Ø¨Ù‹Ø§"],
  evening:["Ø£Ù…Ø³ÙŠÙ†Ø§ ÙˆØ£Ù…Ø³Ù‰ Ø§Ù„Ù…Ù„Ùƒ Ù„Ù„Ù‡","Ø§Ù„Ù„Ù‡Ù… Ø¨Ùƒ Ø£Ù…Ø³ÙŠÙ†Ø§"],
  after:["Ø£Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡","Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡ 33","Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡ 33","Ø§Ù„Ù„Ù‡ Ø£ÙƒØ¨Ø± 34"],
  dua:["Ø±Ø¨Ù†Ø§ Ø¢ØªÙ†Ø§ ÙÙŠ Ø§Ù„Ø¯Ù†ÙŠØ§ Ø­Ø³Ù†Ø©","Ø§Ù„Ù„Ù‡Ù… Ø§Ù‡Ø¯Ù†Ø§"]
};
function showAthkar(t){
  let box=document.getElementById("athkarList");box.innerHTML="";
  ATHKAR[t].forEach(a=>{
    let d=document.createElement("div");
    d.className="card";d.innerText=a;
    box.appendChild(d);
  });
}

// Ø§Ù„Ù‚Ø¨Ù„Ø©
const KAABA_LAT=21.4225,KAABA_LON=39.8262;
function qiblaDir(lat,lon){
  const dLon=(KAABA_LON-lon)*Math.PI/180;
  const y=Math.sin(dLon);
  const x=Math.cos(lat*Math.PI/180)*Math.tan(KAABA_LAT*Math.PI/180)
          -Math.sin(lat*Math.PI/180)*Math.cos(dLon);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}
navigator.geolocation.getCurrentPosition(pos=>{
  const q=qiblaDir(pos.coords.latitude,pos.coords.longitude);
  window.addEventListener("deviceorientation",e=>{
    if(!e.alpha)return;
    let diff=q-e.alpha;
    document.getElementById("needle").style.transform=`rotate(${diff}deg)`;
    if(Math.abs(diff)<5){
      document.getElementById("qiblaText").innerText="âœ… Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù‚Ø¨Ù„Ø©";
      navigator.vibrate?.(200);
    }
  });
});
</script>

</body>
</html>
