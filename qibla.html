<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>بوصلة القبلة - مواقيتي</title>

<style>
body {
  margin: 0;
  font-family: "Tahoma", Arial;
  background: #0b2a3d;
  color: #d4af37;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}

.container {
  text-align: center;
}

h1 {
  margin-bottom: 20px;
  font-size: 28px;
  letter-spacing: 2px;
}

.compass-wrapper {
  position: relative;
  width: 260px;
  height: 260px;
  border-radius: 50%;
  background: radial-gradient(circle, #ffffff 60%, #e0e0e0);
  border: 10px solid #1e3a52;
}

.compass {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background:
    repeating-conic-gradient(
      #ccc 0deg 2deg,
      transparent 2deg 10deg
    );
}

.direction {
  position: absolute;
  font-weight: bold;
  color: #333;
}

.n { top: 10px; left: 50%; transform: translateX(-50%); }
.s { bottom: 10px; left: 50%; transform: translateX(-50%); }
.e { right: 10px; top: 50%; transform: translateY(-50%); }
.w { left: 10px; top: 50%; transform: translateY(-50%); }

.arrow {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 6px;
  height: 110px;
  background: red;
  transform-origin: bottom center;
  transform: translate(-50%, -100%) rotate(0deg);
  border-radius: 3px;
}

.qibla-arrow {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 6px;
  height: 90px;
  background: #0aa;
  transform-origin: bottom center;
  transform: translate(-50%, -100%) rotate(0deg);
  border-radius: 3px;
}

.center-dot {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 14px;
  height: 14px;
  background: #333;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

button {
  margin-top: 20px;
  padding: 10px 18px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  background: #d4af37;
  color: #0b2a3d;
  cursor: pointer;
}

.status {
  margin-top: 12px;
  font-size: 14px;
}
</style>
</head>

<body>
<div class="container">
  <h1>مواقيتي</h1>

  <div class="compass-wrapper">
    <div class="compass"></div>

    <div class="direction n">N</div>
    <div class="direction s">S</div>
    <div class="direction e">E</div>
    <div class="direction w">W</div>

    <div class="arrow" id="needle"></div>
    <div class="qibla-arrow" id="qiblaNeedle"></div>
    <div class="center-dot"></div>
  </div>

  <button id="startBtn">تشغيل بوصلة القبلة</button>
  <div class="status" id="status">بانتظار التشغيل…</div>
</div>

<script>
const KAABA_LAT = 21.4225;
const KAABA_LON = 39.8262;

function toRad(d){ return d * Math.PI / 180; }
function toDeg(r){ return r * 180 / Math.PI; }

function getQibla(lat, lon){
  const dLon = toRad(KAABA_LON - lon);
  const y = Math.sin(dLon);
  const x = Math.cos(toRad(lat)) * Math.tan(toRad(KAABA_LAT)) -
            Math.sin(toRad(lat)) * Math.cos(dLon);
  return (toDeg(Math.atan2(y, x)) + 360) % 360;
}

function startCompass(){
  if (typeof DeviceOrientationEvent.requestPermission === "function") {
    DeviceOrientationEvent.requestPermission().then(p => {
      if (p === "granted") init();
      else status.innerText = "تم رفض الإذن";
    });
  } else {
    init();
  }
}

function init(){
  navigator.geolocation.getCurrentPosition(pos => {
    const qiblaDeg = getQibla(pos.coords.latitude, pos.coords.longitude);
    qiblaNeedle.style.transform =
      `translate(-50%, -100%) rotate(${qiblaDeg}deg)`;

    window.addEventListener("deviceorientation", e => {
      if (e.alpha === null) return;

      const heading = e.alpha;
      needle.style.transform =
        `translate(-50%, -100%) rotate(${heading}deg)`;

      const diff = Math.abs((qiblaDeg - heading + 360) % 360);
      if (diff < 5 || diff > 355) {
        status.innerText = "✔️ القبلة صحيحة";
        if (navigator.vibrate) navigator.vibrate(200);
      } else {
        status.innerText = "حرّك الهاتف باتجاه القبلة";
      }
    });
  }, () => {
    status.innerText = "لم يتم السماح بالموقع";
  });
}

startBtn.onclick = startCompass;
</script>
</body>
</html>
